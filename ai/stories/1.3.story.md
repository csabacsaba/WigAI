# Story 1.3: Implement MCP "Ping" Command

**Status:** Approved

## Goal & Context

**User Story:** As an External AI Agent Developer, I want to send a "ping" command via MCP to the WigAI server and receive a success response as defined in the API specification, so that I can verify connectivity and that WigAI is operational.

**Context:** This story builds upon Stories 1.1 and 1.2, which established the foundational Bitwig extension and basic MCP server implementation. Now we need to implement the first actual MCP command handler - the "ping" command - which serves as both a connectivity check and a pattern for future command implementations. This story introduces the core command parsing and routing infrastructure that will be used for all subsequent MCP commands. Additionally, we'll ensure compatibility with the standard MCP `list/tools` endpoint that comes built-in with the MCP Java SDK.

## Detailed Requirements

* The WigAI MCP server (specifically the `RequestRouter` and `McpCommandParser` components) must be able to receive and process an MCP tool call for "ping" using the JSON-RPC 2.0 format.
* The tool request should follow the official MCP specification format:
  ```json
  {
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
      "name": "ping",
      "arguments": {}
    }
  }
  ```
* Upon receiving a valid "ping" tool call:
    * WigAI should not need to interact with the Bitwig API for this tool.
    * It should construct a success response as specified in the official MCP specification and updated `docs/mcp-api-spec.md`:
      ```json
      {
        "jsonrpc": "2.0",
        "id": 1,
        "result": {
          "content": [
            {
              "type": "text",
              "text": "pong (WigAI v0.2.0)" // Version fetched from WigAIExtensionDefinition
            }
          ],
          "isError": false
        }
      }
      ```
* The version reported in the response should be dynamically retrieved from the `WigAIExtensionDefinition` (or a constant reflecting it).
* The `RequestRouter` should log the receipt of the "ping" tool call and the response sent.
* Ensure the MCP server properly supports the built-in standard MCP endpoints:
  * `tools/list` - This endpoint should return the list of available tools the server supports.
  * For this initial implementation, register the "ping" tool and verify that `tools/list` includes it in its response.

## Acceptance Criteria (ACs)

* AC1: Sending a valid "ping" tool call (using the JSON-RPC 2.0 format with `tools/call` method) to the WigAI server's MCP endpoint results in a successful MCP response with `Content-Type: application/json` and the body matching the specified JSON structure (including "pong" and the current WigAI version).
* AC2: The `Logger` service logs the receipt of the "ping" tool call and the content of the response.
* AC3: Invalid or malformed tool calls (e.g., incorrect JSON, unknown tool name) result in an appropriate JSON-RPC 2.0 error response (e.g., method not found, invalid params) and are logged by the `Logger` service.
* AC4: The version in the response accurately reflects the version set in `WigAIExtensionDefinition`.
* AC5: The standard MCP `tools/list` request returns a valid JSON-RPC 2.0 response listing the "ping" tool with its proper schema definition.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create:
    - `src/main/java/io/github/fabb/wigai/mcp/RequestRouter.java`: Class to route incoming MCP requests to their appropriate handlers
    - `src/main/java/io/github/fabb/wigai/mcp/tool/McpToolRegistry.java`: Class to register and manage MCP tools
    - `src/main/java/io/github/fabb/wigai/mcp/tool/McpTool.java`: Interface defining an MCP tool
    - `src/main/java/io/github/fabb/wigai/mcp/tool/PingTool.java`: Implementation of the "ping" tool
    - `src/main/java/io/github/fabb/wigai/mcp/tool/ToolInputSchema.java`: Helper class for defining tool input schemas

  - Files to Modify:
    - `src/main/java/io/github/fabb/wigai/mcp/McpServerManager.java`: Update to use RequestRouter and standard MCP endpoints

- **Key Technologies:**

  - Java 21 (language features including records, interfaces, etc.)
  - JSON-RPC 2.0 processing (handled by the MCP Java SDK)
  - HTTP/Server-Sent Events handling (managed by MCP Java SDK)
  - MCP Java SDK (using the official tools-based implementation)

- **API Interactions / SDK Usage:**

  - The implementation must adhere to the official MCP specification and updated `docs/mcp-api-spec.md`
  - All interactions must use the JSON-RPC 2.0 format
  - For version information, access `AppConstants.APP_VERSION` or the WigAI extension definition
  - Implement tools interface as specified in the MCP documentation: https://modelcontextprotocol.io/specification/2025-03-26/server/tools
  - Use the standard endpoints `tools/list` and `tools/call`

- **Data Structures:**

  - JSON-RPC 2.0 request/response structures handled by MCP Java SDK
  - Tool-specific input/output schemas defined per tool
  - For the "ping" tool:
    - Request: 
      ```json
      {
        "jsonrpc": "2.0", 
        "id": 1, 
        "method": "tools/call", 
        "params": {
          "name": "ping", 
          "arguments": {}
        }
      }
      ```
    - Response: 
      ```json
      {
        "jsonrpc": "2.0",
        "id": 1,
        "result": {
          "content": [
            {
              "type": "text",
              "text": "pong (WigAI v0.2.0)"
            }
          ],
          "isError": false
        }
      }
      ```

- **Coding Standards Notes:**

  - Implement tool interfaces according to MCP specification
  - Use Java records for tool input/output models where appropriate
  - Follow error handling strategy in `docs/coding-standards.md`
  - Adhere to JSON-RPC 2.0 error codes for appropriate error cases
  - Log appropriate messages for incoming tool calls and responses

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** 
  - Test `RequestRouter` with mock JSON-RPC 2.0 requests to verify correct routing
  - Test `McpToolRegistry` for proper tool registration and retrieval
  - Test `PingTool` implementation specifically
  - Test tool error handling and JSON-RPC error code responses

- **Manual/CLI Verification:** 
  - Use a tool like `curl` to send HTTP POST requests with JSON-RPC 2.0 formatted data:
    - Test the `tools/list` endpoint: `curl -X POST http://localhost:61169/mcp -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":1,"method":"tools/list"}'`
    - Test the `tools/call` endpoint with the ping tool: `curl -X POST http://localhost:61169/mcp -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"ping","arguments":{}}}'`
  - Verify the responses match the expected JSON-RPC 2.0 format
  - Test error cases (invalid method, malformed JSON, etc.) and verify correct error codes
  - Check that log messages appear in the Bitwig extension console

## Tasks / Subtasks

- [ ] Implement MCP tools infrastructure
  - [ ] Create `McpTool` interface to define the contract for all tools
  - [ ] Create `McpToolRegistry` class to register and manage tools
  - [ ] Create `ToolInputSchema` helper class for defining JSON schemas
  - [ ] Implement the `PingTool` class as the first concrete tool

- [ ] Implement request routing with JSON-RPC 2.0 support
  - [ ] Create `RequestRouter` class for handling incoming MCP requests
  - [ ] Add support for the standard `tools/list` endpoint
  - [ ] Add support for the standard `tools/call` endpoint
  - [ ] Add error handling for invalid/malformed requests using JSON-RPC error codes
  - [ ] Register and expose the "ping" tool

- [ ] Update `McpServerManager`
  - [ ] Integrate with `RequestRouter` for processing requests
  - [ ] Ensure proper content type and status codes in HTTP responses
  - [ ] Handle JSON-RPC message parsing
  - [ ] Add error handling for malformed requests

- [ ] Add comprehensive logging
  - [ ] Log incoming tool calls with tool name
  - [ ] Log responses (success or error)
  - [ ] Log any exceptions during processing
  
- [ ] Test MCP standard endpoints
  - [ ] Verify the `tools/list` endpoint correctly lists all registered tools
  - [ ] Verify the `tools/call` endpoint with the "ping" tool
  - [ ] Document how to test these endpoints in a verification guide

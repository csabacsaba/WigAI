# Story 1.3: Implement MCP "Ping" Command

**Status:** Approved

## Goal & Context

**User Story:** As an External AI Agent Developer, I want to send a "ping" command via MCP to the WigAI server and receive a success response as defined in the API specification, so that I can verify connectivity and that WigAI is operational.

**Context:** This story builds upon Stories 1.1 and 1.2, which established the foundational Bitwig extension and basic MCP server implementation. Now we need to implement the first actual MCP tool - the "ping" tool - which serves as both a connectivity check and a pattern for future tool implementations. For this implementation, we should leverage the official MCP Java SDK's built-in components as much as possible for handling JSON-RPC 2.0 message processing, tool registration, and request handling. Additionally, we'll ensure compatibility with the standard MCP `tools/list` endpoint that comes built-in with the MCP Java SDK.

## Detailed Requirements

* The WigAI MCP server should use the MCP Java SDK's built-in components for handling JSON-RPC 2.0 messages, tool registration, and request routing. The server must be able to receive and process an MCP tool call for "ping" using the JSON-RPC 2.0 format.
* The tool request should follow the official MCP specification format:
  ```json
  {
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
      "name": "ping",
      "arguments": {}
    }
  }
  ```
* Upon receiving a valid "ping" tool call:
    * WigAI should not need to interact with the Bitwig API for this tool.
    * It should construct a success response as specified in the official MCP specification and updated `docs/mcp-api-spec.md`:
      ```json
      {
        "jsonrpc": "2.0",
        "id": 1,
        "result": {
          "content": [
            {
              "type": "text",
              "text": "pong (WigAI v0.2.0)" // Version fetched from WigAIExtensionDefinition
            }
          ],
          "isError": false
        }
      }
      ```
* The version reported in the response should be dynamically retrieved from the `WigAIExtensionDefinition` (or a constant reflecting it).
* The MCP server should log the receipt of the "ping" tool call and the response sent.
* Ensure the MCP server properly supports the built-in standard MCP endpoints:
  * `tools/list` - This endpoint should return the list of available tools the server supports.
  * For this initial implementation, register the "ping" tool and verify that `tools/list` includes it in its response.

## Acceptance Criteria (ACs)

* AC1: Sending a valid "ping" tool call (using the JSON-RPC 2.0 format with `tools/call` method) to the WigAI server's MCP endpoint results in a successful MCP response with `Content-Type: application/json` and the body matching the specified JSON structure (including "pong" and the current WigAI version).
* AC2: The `Logger` service logs the receipt of the "ping" tool call and the content of the response.
* AC3: Invalid or malformed tool calls (e.g., incorrect JSON, unknown tool name) result in an appropriate JSON-RPC 2.0 error response (e.g., method not found, invalid params) and are logged by the `Logger` service.
* AC4: The version in the response accurately reflects the version set in `WigAIExtensionDefinition`.
* AC5: The standard MCP `tools/list` request returns a valid JSON-RPC 2.0 response listing the "ping" tool with its proper schema definition.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**

  - Files to Create:
    - `src/main/java/io/github/fabb/wigai/mcp/tool/PingTool.java`: Implementation of the "ping" tool using the MCP Java SDK's tool interfaces

  - Files to Modify:
    - `src/main/java/io/github/fabb/wigai/mcp/McpServerManager.java`: Update to configure and utilize the MCP Java SDK's built-in tool support, server components, and request handling

- **Key Technologies:**

  - Java 21 (language features including records, interfaces, etc.)
  - MCP Java SDK (using the official tools-based implementation)
    - SDK's JSON-RPC 2.0 processing
    - SDK's HTTP/Server-Sent Events handling
    - SDK's tool registry and request routing components

- **API Interactions / SDK Usage:**

  - Leverage the official MCP Java SDK for:
    - Server implementation with Streamable HTTP/SSE transport
    - JSON-RPC 2.0 message processing 
    - Tool registration, validation, and management
    - Standard endpoint handling (`tools/list` and `tools/call`)
    - Request/response flow
    - Error handling
  
  - Focus on using the SDK's built-in components rather than implementing custom ones:
    - Use the SDK's server and transport implementation directly
    - Use the SDK's tool registry system instead of building a custom `RequestRouter`
    - Use the SDK's JSON-RPC message parsing instead of a custom `McpCommandParser`
    - Limit custom code to integration between the SDK and Bitwig-specific functionality
  - The implementation must adhere to the official MCP specification and updated `docs/mcp-api-spec.md`
  - For version information, access `AppConstants.APP_VERSION` or the WigAI extension definition
  - Implement tool classes by extending/implementing the SDK's tool interfaces

- **Data Structures:**

  - JSON-RPC 2.0 request/response structures handled by MCP Java SDK
  - Tool-specific input/output schemas defined per tool
  - For the "ping" tool:
    - Request: 
      ```json
      {
        "jsonrpc": "2.0", 
        "id": 1, 
        "method": "tools/call", 
        "params": {
          "name": "ping", 
          "arguments": {}
        }
      }
      ```
    - Response: 
      ```json
      {
        "jsonrpc": "2.0",
        "id": 1,
        "result": {
          "content": [
            {
              "type": "text",
              "text": "pong (WigAI v0.2.0)"
            }
          ],
          "isError": false
        }
      }
      ```

- **Coding Standards Notes:**

  - Implement tool interfaces according to MCP specification
  - Use Java records for tool input/output models where appropriate
  - Follow error handling strategy in `docs/coding-standards.md`
  - Adhere to JSON-RPC 2.0 error codes for appropriate error cases
  - Log appropriate messages for incoming tool calls and responses

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** 
  - Test the MCP Java SDK integration and server configuration
  - Test proper tool registration and retrieval using the SDK's registry
  - Test `PingTool` implementation specifically
  - Test tool error handling and JSON-RPC error code responses using the SDK's facilities

- **Manual/CLI Verification:** 
  - Use a tool like `curl` to send HTTP POST requests with JSON-RPC 2.0 formatted data:
    - Test the `tools/list` endpoint: `curl -X POST http://localhost:61169/mcp -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":1,"method":"tools/list"}'`
    - Test the `tools/call` endpoint with the ping tool: `curl -X POST http://localhost:61169/mcp -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"ping","arguments":{}}}'`
  - Verify the responses match the expected JSON-RPC 2.0 format
  - Test error cases (invalid method, malformed JSON, etc.) and verify correct error codes
  - Check that log messages appear in the Bitwig extension console

## Tasks / Subtasks

- [ ] Set up MCP Java SDK
  - [ ] Configure the SDK's tool registry in `McpServerManager`
  - [ ] Set up the SDK's server with Streamable HTTP/SSE transport
  - [ ] Configure the SDK's JSON-RPC 2.0 message processing
  - [ ] Set up proper error handling using the SDK's facilities

- [ ] Implement the "ping" tool
  - [ ] Create `PingTool` class implementing the SDK's tool interface
  - [ ] Define appropriate input/output schema using SDK utilities
  - [ ] Implement the tool handler to return the version-based "pong" response
  - [ ] Register the tool with the SDK's tool registry

- [ ] Add logging integration
  - [ ] Create logging adapter between `Logger` service and SDK
  - [ ] Configure SDK to use our logging service
  - [ ] Ensure appropriate logging of tool calls and responses

- [ ] Implement version retrieval
  - [ ] Ensure version information can be obtained from extension definition
  - [ ] Use the version in the "ping" response

- [ ] Test SDK-based MCP endpoints
  - [ ] Verify the SDK's built-in `tools/list` endpoint works correctly
  - [ ] Verify the SDK's built-in `tools/call` endpoint with the "ping" tool
  - [ ] Document how to test these endpoints in a verification guide

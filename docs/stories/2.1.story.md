# Story 2.1: Read Selected Device's Parameters via MCP

## Status: Ready

## Story

- As an External AI Agent
- I want to request the current names and values of the eight addressable parameters of the user-selected device in Bitwig via an MCP command
- so that I can understand the device's state for display or further manipulation

## Acceptance Criteria (ACs)

1. Sending the "get_selected_device_parameters" MCP command returns an MCP response with `status: "success"` and a `data` payload containing the `device_name` and an array of `parameters` (each with `index`, `name`, `value`, `display_value`) for the currently selected Bitwig device.
2. The parameter names, values, and display values in the response accurately reflect their current state in Bitwig's selected device.
3. If a device has fewer than 8 addressable parameters, only the available ones are returned, or null/empty placeholders are used for the remaining as per Bitwig API behavior (the facade should normalize this).
4. If no device is selected in Bitwig, the response data contains `device_name: null` and `parameters: []`.
5. The `Logger` service logs the command receipt and the summarized response.

## Tasks / Subtasks

- [ ] Create `DeviceController` feature module class (AC: 1, 2, 3, 4)
  - [ ] Create `DeviceController.java` in `src/main/java/io/github/fabb/wigai/features/`
  - [ ] Implement method to get selected device parameters using `BitwigApiFacade`
  - [ ] Handle cases for no device selected, fewer than 8 parameters
- [ ] Create MCP tool for device parameter retrieval (AC: 1, 5)
  - [ ] Create `DeviceParamTool.java` in `src/main/java/io/github/fabb/wigai/mcp/tool/`
  - [ ] Implement `get_selected_device_parameters` tool using MCP Java SDK
  - [ ] Register tool with MCP server in `McpServerManager`
- [ ] Extend `BitwigApiFacade` with device parameter methods (AC: 2, 3)
  - [ ] Add methods to access selected device and its parameters
  - [ ] Handle Bitwig API calls for device parameter bank (8 parameters)
  - [ ] Normalize parameter data (name, value, display_value)
- [ ] Implement response data structures (AC: 1)
  - [ ] Ensure `ParameterInfo` record exists as per `data-models.md`
  - [ ] Create response structure following MCP tool result format
- [ ] Add comprehensive logging (AC: 5)
  - [ ] Log command receipt in tool implementation
  - [ ] Log device selection status and parameter count
  - [ ] Log response summary
- [ ] Write unit tests for new components
  - [ ] Test `DeviceController` logic with mocked `BitwigApiFacade`
  - [ ] Test MCP tool parameter validation and response formatting
  - [ ] Test edge cases (no device, no parameters)

## Dev Technical Guidance

### Architecture Context
This story implements the first device control feature in Epic 2, building upon the foundation established in Epic 1. The implementation follows the tool-based MCP pattern using the MCP Java SDK v0.10.0.

### Key Technical Requirements

**MCP Tool Implementation:**
- Use MCP Java SDK's tool interfaces and registry system
- Tool name: `get_selected_device_parameters` 
- No input arguments required (empty schema)
- Return structured tool result following `docs/data-models.md` format

**Data Structures (from `docs/data-models.md`):**
```java
// ParameterInfo record
public record ParameterInfo(
    int index,           // 0-7
    String name,         // Nullable
    double value,        // 0.0-1.0 normalized
    String display_value // Bitwig's display string
) {}
```

**Response Format:**
- Text response with formatted device parameters information
- Resource response with JSON data containing `device_name` and `parameters` array
- Follow MCP tool result structure from data models document

### Component Integration

**DeviceController Feature Module:**
- Location: `src/main/java/io/github/fabb/wigai/features/DeviceController.java`
- Responsibility: Business logic for device parameter operations
- Dependencies: `BitwigApiFacade`, `Logger`

**BitwigApiFacade Extensions:**
- Add device selection detection methods
- Add parameter bank access methods (8 macro parameters)
- Handle parameter normalization and display value formatting
- Location: `src/main/java/io/github/fabb/wigai/bitwig/BitwigApiFacade.java`

**MCP Tool Registration:**
- Register tool in `McpServerManager.java`
- Follow existing pattern from transport tools in Epic 1

### Error Handling Strategy (from `docs/operational-guidelines.md`)

**Input Validation:**
- No parameters to validate for this command
- Validate MCP request structure in tool implementation

**Bitwig API Error Handling:**
- Graceful handling when no device is selected
- Handle devices with fewer than 8 parameters
- Log any Bitwig API exceptions and return appropriate error responses

**Logging Requirements:**
- Log command receipt with context
- Log device selection status
- Log parameter retrieval results
- Use centralized `Logger` service wrapping `host.println()`

### Testing Strategy (from `docs/operational-guidelines.md`)

**Unit Tests:**
- Mock `BitwigApiFacade` for `DeviceController` tests
- Test parameter data transformation and normalization
- Test empty/null device scenarios

**Integration Tests:**
- Test MCP tool registration and routing
- Test tool call processing with mocked Bitwig components

**Manual E2E Testing:**
- Load extension in Bitwig Studio
- Select different devices with varying parameter counts
- Send MCP commands via test client
- Verify parameter values match Bitwig UI

### Project Structure Alignment

All new files follow the established structure from `docs/project-structure.md`:
- Feature modules in `features/` package
- MCP tools in `mcp/tool/` package  
- Root package: `io.github.fabb.wigai`
- Test files mirror main structure in `src/test/java/`

### Related Documentation
- `docs/data-models.md` - Response structure definitions
- `docs/api-reference.md` - MCP API specification
- `docs/architecture.md` - Component interaction patterns
- `docs/operational-guidelines.md` - Error handling and logging standards

## Story Progress Notes

### Agent Model Used: `GitHub Copilot`

### Completion Notes List
{To be populated during implementation}

### Change Log
| Date | Change | Author |
|------|--------|--------|
| 2025-05-25 | Initial story creation | Technical Scrum Master Agent |

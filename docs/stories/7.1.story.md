# Story 7.1: Implement `list_scenes` Tool

**Epic:** [Epic 7: Scene and Clip Information Retrieval](../prd/epic-7.md)

**User Story:**

*   As an AI agent, I want to list all scenes in the current project with their name, color, and selection status, so I can understand the song's structure and identify the currently cued scene.

**Acceptance Criteria:**

*   An MCP tool named `list_scenes` is implemented and registered in the MCP server.
*   **Request Parameters:** None.
*   **Response Body:** An array of scene objects, each containing:
    *   `index` (integer): 0-based index of the scene across the entire project (not limited to the visible window).
    *   `name` (string): Name of the scene.
    *   `color` (string, nullable): Scene color as an RGB string formatted exactly as `rgb(r,g,b)` where `r`, `g`, and `b` are integers in the range 0–255. Use `null` if the color is not available from the API.
    *   `is_selected` (boolean): True if and only if this scene is the Bitwig global scene selection/cursor in the launcher (the globally cued scene). If no global scene is selected, all items must have `is_selected=false`.
*   The `list_scenes` tool queries the Bitwig API (e.g., SceneBank) to retrieve all scenes and their specified information, correctly handling paged/scrolling access so that all scenes are returned, not just the currently visible window.
*   Selection detection uses Bitwig’s global scene cursor/selection semantics (not per-track clip states).
*   The tool functions correctly in an empty project (returns `[]`).
*   [docs/api-reference.md](docs/api-reference.md) is updated with:
    *   The `list_scenes` tool entry (name, description).
    *   An explicit “no parameters” JSON schema.
    *   A concrete example response showing at least two scenes and correct `rgb(...)` formatting.
*   Error handling aligns with the existing MCP tool framework (e.g., `McpErrorHandler`) and `ErrorCode`. On Bitwig API failures/unavailability, return a standardized error with `BITWIG_API_ERROR`.
*   The tool is registered alongside existing tools in [src/main/java/io/github/fabb/wigai/mcp/McpServerManager.java](src/main/java/io/github/fabb/wigai/mcp/McpServerManager.java).
*   Unit tests are implemented in `src/test/java/io/github/fabb/wigai/mcp/tool/ListScenesToolTest.java` covering:
    *   Empty project -> `[]`.
    *   Multiple scenes with distinct names and colors.
    *   Selection at first, middle, and last scene.
    *   No current global scene selection -> all `is_selected=false`.
    *   Scenes without color -> `color=null`.
    *   Pagination across more scenes than a single bank window exposes.
*   Manual testing instructions are added using `tools/call` to validate fields and selection against a real Bitwig project, extending [docs/testing/mcp-endpoints-verification.md](docs/testing/mcp-endpoints-verification.md).
*   Non-functional: The call must be non-blocking and performant, avoiding UI-thread blocking; reasonable performance for large scene counts.

Example `tools/call` (replace port as needed):

```bash
curl -X POST http://localhost:61169/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"list_scenes","arguments":{}}}'
```

Example response (truncated):

```json
[
  { "index": 0, "name": "Intro",  "color": "rgb(255,128,0)", "is_selected": false },
  { "index": 1, "name": "Verse",  "color": "rgb(0,180,255)", "is_selected": true  }
]
```

**Tasks:**

1.  Create `ListScenesTool.java` following the existing MCP tool pattern (static `specification(...)` returning `McpServerFeatures.SyncToolSpecification`), consistent with tools like [src/main/java/io/github/fabb/wigai/mcp/tool/ListTracksTool.java](src/main/java/io/github/fabb/wigai/mcp/tool/ListTracksTool.java).
2.  Implement logic to access Bitwig scenes via `SceneBank` (using `BitwigApiFacade` and/or [src/main/java/io/github/fabb/wigai/bitwig/SceneBankFacade.java](src/main/java/io/github/fabb/wigai/bitwig/SceneBankFacade.java)) and iterate across the full bank to collect all scenes.
3.  For each scene, extract `index`, `name`, `color` (convert to `rgb(r,g,b)` string; `null` if unavailable), and `is_selected` (from global scene selection/cursor).
4.  Return the array of scene objects directly from the MCP tool handler using the unified error handling approach (`McpErrorHandler`) and consistent `ErrorCode`s.
5.  Update [docs/api-reference.md](docs/api-reference.md) with the `list_scenes` tool specification (name, description, empty-params schema, example response).
6.  Register the tool in [src/main/java/io/github/fabb/wigai/mcp/McpServerManager.java](src/main/java/io/github/fabb/wigai/mcp/McpServerManager.java) alongside existing tools.
7.  Write JUnit tests in `src/test/java/io/github/fabb/wigai/mcp/tool/ListScenesToolTest.java` covering the acceptance scenarios (empty project, multiple scenes, selection variants, color nulls, pagination).
8.  Perform manual integration testing using the curl example above and document any project-specific notes in [docs/testing/mcp-endpoints-verification.md](docs/testing/mcp-endpoints-verification.md).